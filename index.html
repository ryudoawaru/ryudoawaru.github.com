
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>慕凡(@ryudoawaru)'s blog</title>
  <meta name="author" content="Mu-Fan Teng">

  
  <meta name="description" content="今年的 RubyKaigi 2016 是我從 2013 以來，連續第四年參加的 RubyKaigi，前面三次除了去年以外都有留下一些紀錄（2013, 2014） RubyKaigi 是神馬？ RubyKaigi 是日本最大的 Ruby 語言年度研討會，Kaigi 就是日文漢字的「会議」， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ryudo.tw/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="慕凡(@ryudoawaru)'s blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">慕凡(@ryudoawaru)'s blog</a></h1>
  
    <h2>目前還沒想到</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:ryudo.tw" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/my-presentations">My Presentations</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/09/26/my-rubykaigi-2016-tour/">RubyKaigi 2016</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-09-26T17:35:00+08:00" pubdate data-updated="true">Sep 26<span>th</span>, 2016</time>
        
         | <a href="/blog/2016/09/26/my-rubykaigi-2016-tour/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>今年的 RubyKaigi 2016 是我從 2013 以來，連續第四年參加的 RubyKaigi，前面三次除了去年以外都有留下一些紀錄（<a href="/blog/2013/06/07/rubykaigi2013-lt/">2013</a>, <a href="/blog/2014/09/28/shibuya-it-tour-by-igaiga555/">2014</a>）</p>

<h3>RubyKaigi 是神馬？</h3>

<p><a href="http://rubykaigi.org">RubyKaigi</a> 是日本最大的 Ruby 語言年度研討會，Kaigi 就是日文漢字的「会議」，在日本除了全國性的這個 RubyKaigi 外，也有很多地區性（Regional）的 RubyKaigi，例如去年底我受邀參加的<a href="/blog/2015/11/18/oedork-and-rwc/">大江戶 RubyKaigi</a> 等。</p>

<h3>今年的行程</h3>

<p>和去年一樣，今年的 RubyKaigi 行除了參加 conf 外，同時也是敝公司的年度員工旅遊，所以提前在 conf 前一週的 9/3 出發到大阪，9/6 移師到京都，然後在 Kaigi 結束後的隔天 9/11 回台。</p>

<p>團員的構成是包含我在內的 12 名<a href="http://5xRuby.tw">五倍紅寶石</a>正職員工以及 2 位實習生（是的，你沒看錯，在本公司實習就是有這種福利）以及公司的講師和合作夥伴共 4 位一共 18 人。</p>

<p><img src="/images/2016-rubykaigi/1st-Day_4735.jpg" alt="" /></p>

<p>行程大概是長這樣：</p>

<ul>
<li>9/3 出發，晚上逛街</li>
<li>9/4 宅宅日本橋調查兵團組 &amp; USJ 組</li>
<li>9/5 京女大交流 &amp; 神戶.rb 交流</li>
<li>9/6 移師京都 &amp; 嵐山遊</li>
<li>9/7 二条城 &amp; 川崎重工參訪 &amp; pre-Party</li>
<li>9/8 DAY1 &amp; Official Party</li>
<li>9/9 DAY2 &amp; 一次會 &amp; <a href="https://goo.gl/Dpq6tL">#RubyKaraoke</a></li>
<li>9/10    DAY3 &amp; After Party</li>
<li>9/11    歸國</li>
</ul>


<p>個別行程的內容由於已經有同事寫出遊記，在此就不特別贊述，可以參考下面的連結：</p>

<ul>
<li><a href="http://blog.frost.tw/posts/2016/09/17/the-new-vision-after-rubykaigi2016/">蒼時</a></li>
<li><a href="http://lctseng-blog.logdown.com/posts/924824-rubykaigi-2016">@lctseng</a></li>
<li><a href="https://goo.gl/tA8qUL">Roy</a></li>
<li><a href="https://goo.gl/PQurTH">Nina</a></li>
<li><a href="https://goo.gl/JXs9Dn">Yusheng</a></li>
<li><a href="https://goo.gl/7oR3JM">Cat</a></li>
<li><a href="https://goo.gl/nvBUZj">Alan</a></li>
<li><a href="https://goo.gl/QvMz2D">Treekey</a></li>
<li><a href="https://goo.gl/V8tXhM">Sabrina</a></li>
<li><a href="https://goo.gl/t5sm5t">孟穎</a></li>
</ul>


<h3>會場</h3>

<p>會場「<a href="http://www.icckyoto.or.jp/">国立京都国際会館</a>」應該是今年最大的亮點，很可能也是未來永遠無法超越的經典了，不愧是簽訂過「<a href="https://zh.wikipedia.org/wiki/%E4%BA%AC%E9%83%BD%E8%AE%AE%E5%AE%9A%E4%B9%A6">京都議定書</a>」的地方，除了國際級的內裝和座位數（超過 1700）外，最厲害的就是會場旁的庭院，會有種讓人誤以為是在山中而不是都會區的錯覺。</p>

<p><img src="/images/2016-rubykaigi/IMG_1345.jpg" alt="" />
<img src="/images/2016-rubykaigi/IMG_1346.jpg" alt="" /></p>

<p>庭院區的後面還有一個很大的池子，目測大概和花蓮的鯉魚潭差不多的程度，以後有機會一定還要再來看看。</p>

<h3>議程</h3>

<p>和往年一樣陣容堅強的<a href="http://rubykaigi.org/2016/schedule/">議程</a>，特色是沒有 Rails 功能直接相關的議程，然後 mruby 相關的議程很多，我個人還蠻期待 <a href="http://rubykaigi.org/2016/presentations/udzura.html">haconiwa</a> 這個 LXC 實作的，除了和往年一樣提供日翻英口譯外，今年甚至有幾位日本講者像 @_ko1 和前面提到的 haconiwa 是直接以英文發表，對於一個在日本舉辦的會議來說算是相當不簡單的事情，不過最後總召（日本這邊叫 Chief Organizer）松田大神也在閉幕式時提到因為要節省口譯費用所以鼓勵日本講者們多多以英文發表。</p>

<p>@youchan 的「<a href="http://rubykaigi.org/2016/presentations/youchan.html">Isomorphic web programming in Ruby</a>」主要是繼去年的「<a href="http://rubykaigi.org/2015/presentations/youchan">Writing web application in Ruby</a>」也就是用 Opal = Ruby 語法寫 JS 和 React 後，再加上另一個新的 Gem 去做 Isomorphic，聽起來很炫，不過個人目前還無法突破用 Ruby 語法寫 JS 這個關卡就是。</p>

<p>第二天的 <a href="http://rubykaigi.org/2016/presentations/searls.html">Keynote</a> 講者 Justin Searls 之前就聽 Juanito 推薦過他好多次，除了內容外，演講技巧和 Slide 也都非常棒，可惜今年來不及邀請他在 RubyConf Taiwan 發表了。</p>

<p>這次和前幾年一樣也都有台灣人的議程上榜，其中也有我們家蒼時，和 iCHEF 的 John，今年會場的台灣會眾加本公司大概有 30 上下，應該是除了日本美國以外人數排第三的國家。</p>

<h3>週邊活動</h3>

<p>和過往一樣，RubyKaigi 這一週從會前一天（週三）到週六，每天晚上都有無限制的酒食 Party，不過和過往不同的地方是&#8211;大部份的 Party 都要自費，主要是因為今年超低的票價（Early Bird：10,000 Yen，去年同樣票種是 25,000）無法包山包海之故，唯三免費的是第二天由 Misoca 和 Agile Works 主辦的兩場並行 Party 和我最期待的 <a href="https://goo.gl/Dpq6tL">#RubyKaraoke</a>（感謝贊助商 <a href="http://www.drecom.co.jp/">Drecom</a>），這次因為沒有終電拘束器（旅館在 KTV 場地附近），最後唱到了 3:30，結束後還一起去吃拉麵，好不開心。</p>

<iframe src="https://www.facebook.com/plugins/post.php?href=https%3A%2F%2Fwww.facebook.com%2Fryudoawaru%2Fposts%2F10206717368805302&width=500" width="500" height="588" style="border:none;overflow:hidden" scrolling="no" frameborder="0" allowTransparency="true"></iframe>


<p>最後的 After Party 還特地請我們家 Nina 妹妹上去發表 LT 推一下即將在 12/2~3 舉辦的 RubyConf Taiwan 2016！</p>

<blockquote class="twitter-tweet" data-lang="zh-tw"><p lang="en" dir="ltr">The RubyKaigi 2016 After Party &amp; Lightning Talks! <a href="https://twitter.com/hashtag/rubykaigi?src=hash">#rubykaigi</a> (@ Gion in Kyoto, Kyōto) <a href="https://t.co/6tQD51aC9V">https://t.co/6tQD51aC9V</a> <a href="https://t.co/gVz4vB4ekM">pic.twitter.com/gVz4vB4ekM</a></p>&mdash; tzwm (@tzwm) <a href="https://twitter.com/tzwm/status/774582538723553282">2016年9月10日</a></blockquote>




<blockquote class="twitter-tweet" data-lang="zh-tw"><p lang="en" dir="ltr">. @itsmeninayeh &#39;s presentation! <a href="https://twitter.com/hashtag/rubykaigi?src=hash">#rubykaigi</a> <a href="https://t.co/NdYguHWyyW">pic.twitter.com/NdYguHWyyW</a></p>&mdash; Koichi ITO (@koic) <a href="https://twitter.com/koic/status/774581356542033920">2016年9月10日</a></blockquote>


<h3>總結</h3>

<p>從 2013 以來每年都參加 RubyKaigi，每年都有亮點，但對我自己來說最大的變化是每年的同行陣容都不一樣：</p>

<ul>
<li>2013：自己當 LT 講者和社群的朋友同行</li>
<li>2014：和同事、朋友以及一群被 Heroku 與日本社群朋友贊助的 Rails Girls 們同行</li>
<li>2015：變成公司旅遊行程，團員 6 名</li>
<li>2016：團員變成去年的 3 倍（今年不是五倍嗎？）</li>
</ul>


<p>每年的陣容也反應了人生階段的演變，目前的遺憾是還沒有機會作為正式議程的講者上台，希望未來還有機會。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/02/23/apply-letsencrypt-ssl-under-nginx/">用 Letsencrypt-cli Rubygem 在 Nginx 上實裝 Let&#8217;s Encrypt 免費 SSL 服務</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-02-23T12:40:00+08:00" pubdate data-updated="true">Feb 23<span>rd</span>, 2016</time>
        
         | <a href="/blog/2016/02/23/apply-letsencrypt-ssl-under-nginx/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://letsencrypt.org/">Let&#8217;s Encrypt</a> 是一個（目前）免費的 SSL 服務，它和其它 SSL 服務商的不同，除了免費之外，就是它需要透過一些方式來驗證你對網站的所有權來申請與更新憑證，而且一次憑證的有效期限（目前）最大是 90 天，也就是說你要持續定期的更新憑證才能使用。</p>

<h3>Let&#8217;s Encrypt 運作原理</h3>

<p>如<a href="https://letsencrypt.org/howitworks/technology/">官網</a>所示，比較白話一點的流程大概是：</p>

<ol>
<li>用指令向 Let&#8217;s Encrypt 要求產生驗證 host example.com 的檔案</li>
<li>LE 給你驗證檔案</li>
<li>你將檔案放在 http://example.com/.well-known/acme-challenge 下</li>
<li>LE 會發出 HTTP Request 驗證該檔案是否存在前述 URL 下</li>
<li>如果有，則發放證書</li>
</ol>


<p>今天要講的是用 Nginx 加上<a href="https://github.com/zealot128/ruby-letsencrypt-cli">Let&#8217;s Encrypt Ruby Cli Rubygem</a>的驗證方法</p>

<h4>為何要使用 ruby-letsencrypt-cli 而非 LE 官方版本 CLI</h4>

<ul>
<li>不需要 root 權限即可執行</li>
<li>函式庫相依性較簡單</li>
<li>功能相對單純</li>
</ul>


<h4>安裝 Let&#8217;s Encrypt Ruby Cli</h4>

<p>安裝方式就是單純的 <code>gem install letsencrypt-cli</code> 即可。</p>

<h4>事前準備</h4>

<ul>
<li>安裝好 Gem</li>
<li>預備好以下目錄：

<ul>
<li>key-directory：放 key 的地方</li>
<li>webroot-path：在前述的 step 3 給 LE 做 acme-challenge 的檔案放置目錄</li>
<li>放置 account_key 的目錄，通常會放在你的 home</li>
<li>在你要生 SSL 證書的網站的 Virtual Host 的設定內放置以下設定並重啟 nginx，讓 LE 可以用 <code>http://example.com/.well-known/acme-challenge</code> 的網址認證 ：</li>
</ul>
</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>server{
</span><span class='line'>  ...
</span><span class='line'>  location '/.well-known/acme-challenge/' {
</span><span class='line'>    default_type "text/plain";
</span><span class='line'>    alias /var/www/acme-challenge/;
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ul>
<li>註冊 account，執行：<code>letsencrypt-cli register xxx.ooo.com</code> ，產生帳號密鑰 account_key.pem</li>
<li>讓 LE 認證你的網站，執行：<code>letsencrypt-cli authorize --webroot-path /var/www/acme-challenge example.com</code></li>
<li>生成 key：<code>cd key-directory &amp;&amp; letsencrypt-cli cert example.com</code>，會生成：cert.pem  chain.pem  fullchain.pem  key.pem 等四個檔案</li>
<li>設定 Nginx 在 Virtual Host 使用剛才產生的檔案：</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>server{
</span><span class='line'>   ...
</span><span class='line'>   ssl_certificate key-directory/fullchain.pem;
</span><span class='line'>   ssl_certificate_key key-directory/key.pem;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ul>
<li>重啟 Nginx，完成</li>
</ul>


<h4>更新 Key</h4>

<p>執行</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>letsencrypt-cli manage --days-valid 30 -a :account_key.pem的位置: --webroot-path /var/www/acme-challenge --key-directory /etc/letsencrypt/live :你要更新的 hosts 以空白分隔:
</span></code></pre></td></tr></table></div></figure>


<p>建議把它加到 crontab 中定時執行</p>

<h3>問題整理：</h3>

<ul>
<li>執行 letsencrypt-cli 出現 <code>Acme::Client::Error::Malformed</code> 錯誤：請降級你的 json-jwt  gem 到 1.5.2</li>
<li>出現 Account Key Note Found：命令列加上 <code>-a :account_key.pem的位置:</code></li>
<li>openssl 版本太舊：openssl 版本建議在 1.0.2 以上，特別是如果要跑 http/2 的話</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/02/05/upgrade-5xruby-to-5-dot-0-beta/">將 5xruby.tw 升級到 Rails 5.0.0.beta2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-02-05T15:01:00+08:00" pubdate data-updated="true">Feb 5<span>th</span>, 2016</time>
        
         | <a href="/blog/2016/02/05/upgrade-5xruby-to-5-dot-0-beta/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近將敝公司 5xruby.tw 的官網的 Rails 版本升級到 5.0.0.beta2，具體的升級 commit 主要在 <a href="https://github.com/5xRuby/5xruby.tw/commit/5d7587d341e63bb0260c52410dafd4514c38bbc4">5d7587d</a>，以下是一些步驟說明：</p>

<ol>
<li>確認 Ruby 版本在 2.2.1 以上，最好是 2.3</li>
<li>在 Gemfile 設定 rails 的版本為 5.0.0.beta2</li>
<li>同時，確認所有安裝的 Rubygem 是否需要升級，將版號設定好</li>
<li>執行 <code>bundle update</code></li>
<li>先執行 <code>rails update</code> 確認是否每個檔案都需要更改，先讓每個檔案都被覆寫到，再回頭看 diff 進行必要修改</li>
</ol>


<p>需要配合升級的 RubyGem</p>

<ol>
<li>kaminari: 請用 Github 上的 Master branch</li>
<li>simple_form: 請使用最新版 3.2.1</li>
<li>acts-as-taggable-on: 一定要用 Master branch，即使版號看起來一樣</li>
<li>rack-mini-profiler: Master branch</li>
<li>Rails 相關的 Asset Rubygems</li>
<li>Capistrano 升級後配合修改 Capfile 中的版號</li>
</ol>


<p>這次升級比預料中平穩，沒有花很多時間就完成了。</p>

<p>以上</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/02/02/upgrade-postgresql-on-osx/">在 OSX 下升級 Homebrew 安裝的 PostgreSQL(dump 版)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-02-02T15:28:00+08:00" pubdate data-updated="true">Feb 2<span>nd</span>, 2016</time>
        
         | <a href="/blog/2016/02/02/upgrade-postgresql-on-osx/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>前言</h3>

<p>繼上一篇的 <a href="/blog/2015/02/15/upgrade-pgsql-from-93-to-94/">在 Mac / Homebrew 下升級 PostgreSQL 從 9.3 到 9.4</a> 之後，最近由於更換筆電 / 不想用 TimeMachine 加上剛好 PostgreSQL 9.5 發佈的關係，必需重新用 Homebrew 安裝 PostgreSQL 9.5，本來使用了前篇所介紹的方式來移轉舊版 PostgreSQL 9.4 的資料檔，但是很神奇地發現在所有 Rails App 的 DB 中的 schema_migration 表的資料通通遺失了，所以就必需要使用另一種方式來升級。</p>

<h3>升級的方式</h3>

<p>一般來說有以下兩種</p>

<ul>
<li><p>從資料檔案 (raw data file) 轉移</p>

<p>不像 MySQL，PostgreSQL 每個版本的 raw data file 都是不相容的（註：MySQL 也要看 Storage Engine），所以當升級新版的時候是不能直接套用的，PostgreSQL 也提供了 pg_upgrade 指令來幫助升級，這也是前一篇的主題。</p></li>
<li><p>使用 SQL 檔案轉移</p>

<p>使用 pg_dump 或 pg_dumpall 等工具將舊 DB Dump 成 SQL 指令的格式，再輸入到新 DB 上即可></p></li>
</ul>


<h3>流程</h3>

<ol>
<li><p>更改資料檔目錄</p>

<p>Homebrew 預設的資料檔目錄在 <code>/usr/local/var/postgres</code> 請把它移到另一個目錄去</p></li>
<li><p>自舊版 PostgreSQL Dump SQL 檔案</p>

<p>如果還沒有升級新版前，就直接執行</p>

<p><code>
pg_dumpall -c -f 目的檔案名
</code></p>

<p>即可，選項 -c 是在 dump 檔中附加移除既存 DB 的指令，可視個人需求決定要不要加。</p>

<p>要是已經升級新版的話，由於 PostgreSQL 套件的發佈者都很貼心的把所有檔案照版本排列，所以可以用以下的指令開啟一個暫時的 PostgreSQL Daemon</p>

<p><code>
/usr/local/Cellar/postgresql/9.4.1/bin/postmaster -D /usr/local/var/postgres94/ -k /tmp/pg94/ -p 8822
</code></p>

<p>選項中 -D 是指定資料檔目錄，-k 是 socket file 的目錄，-p 是 port，要注意這兩者都不能和執行中的新版本重疊，這樣就順利開啟了服務，然後再執行 <code>pg_dumpall -c -p 8822 -h /tmp/pg94</code> 就可以取得 dump SQL 檔了</p></li>
<li><p>自 dump SQL 檔還原到新版資料庫中</p>

<p>在上一步的 dump 指令中就可以用 pipe 一步完成了：</p>

<p><code>pg_dumpall -c -p 8822 -h /tmp/pg94 | psql postgres</code></p></li>
</ol>


<p>以上</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/12/31/pgsql-inheritance/">Table Inheritance in PostgreSQL</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-12-31T12:17:00+08:00" pubdate data-updated="true">Dec 31<span>st</span>, 2015</time>
        
         | <a href="/blog/2015/12/31/pgsql-inheritance/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>前言</h3>

<p><a href="http://api.rubyonrails.org/classes/ActiveRecord/Inheritance.html">Single Table Inheritance</a>（以下簡稱 STI） 是我們在 Rails 常用的一個功能，一般來說 STI 在 Rails 的實現方式如下：</p>

<ol>
<li>一張資料表</li>
<li>多個 ActiveRecord Class 使用這張表</li>
<li>預設用 type 這個欄位來界定這筆紀錄所屬的 class</li>
</ol>


<p>這樣做的好處是子類別可以用父類別的欄位，主要的缺點是在可能會浪費到不需要的欄位；Rails 之所以這樣設計，主要是因為大部份的 RDBMS 系統除了 PostgreSQL 和 Oracle 以外幾乎都沒有實作 Table Inheritance。</p>

<h3>PostgreSQL 的 Table Inheritance</h3>

<p>PostgreSQL 的 Table Inheritance 和 STI 最大的差別在於多表繼承，在官網上就有相當詳細的<a href="http://www.postgresql.org/docs/9.1/static/ddl-inherit.html">介紹</a>，基本上就是在資料表之間實作出繼承的關係，B 表繼承 A 表的話，則：</p>

<ul>
<li>B 表會有所有 A 表的欄位資訊</li>
<li>即使日後 A 表欄位有所變動，也會即時反應到 B 表上</li>
<li>B 表所建立的資料，在查尋 A 表時會全部出現，反之則無</li>
</ul>


<p>接下來我們就來介紹如何在 Rails 中用 PostgreSQL 的 Table Inheritance 來實作 ActiveRecord 的物件繼承。</p>

<h4>期望的 Schema</h4>

<p><img src="/images/pgsql-inheritance/schema.png" alt="" /></p>

<h4>實作</h4>

<p>建立父類別 User</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rails g model User
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CreateUsers</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span><span class="o">[</span><span class="mi">5</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">change</span>
</span><span class='line'>    <span class="n">create_table</span> <span class="ss">:users</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:username</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:password</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:type</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>建立 sub-class Staff</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rails g model Staff
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CreateStaffs</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span><span class="o">[</span><span class="mi">5</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">up</span>
</span><span class='line'>    <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span>
</span><span class='line'><span class="sh">    CREATE TABLE staffs(level integer,CONSTRAINT &quot;PK&quot; PRIMARY KEY (id))</span>
</span><span class='line'><span class="sh">    INHERITS(users)</span>
</span><span class='line'><span class="no">    SQL</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">down</span>
</span><span class='line'>    <span class="n">drop_table</span> <span class="ss">:staffs</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Staff</span> <span class="o">&lt;</span> <span class="no">User</span>
</span><span class='line'>  <span class="nb">self</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span> <span class="s1">&#39;staffs&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>和原本 STI 的行為不同，由於 ActiveRecord Migration 並沒有內建相關功能，所以需要自行撰寫 SQL 式來建立 Staffs 表，在建立時需實際指定繼承自 users 表，並且將額外附加的欄位等屬性設定進去即可。</p>

<p>在 Model 的程式方面，必需指定子類別的資料表，否則 Rails 會按照 STI 預設行為去使用父類別的資料表（users）。</p>

<p>在這個範例中，在 staffs 表建立的資料都會出現在 users 表上，反之則不會。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">username</span><span class="p">:</span> <span class="s1">&#39;ryudo&#39;</span><span class="p">,</span> <span class="ss">password</span><span class="p">:</span><span class="s1">&#39;12345&#39;</span><span class="p">)</span>
</span><span class='line'><span class="no">Staff</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">username</span><span class="p">:</span><span class="s1">&#39;Jodeci&#39;</span><span class="p">,</span><span class="ss">password</span><span class="p">:</span><span class="s1">&#39;12345&#39;</span><span class="p">)</span>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:username</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">4</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;users&quot;</span><span class="o">.</span><span class="s2">&quot;username&quot;</span> <span class="no">FROM</span> <span class="s2">&quot;users&quot;</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;ryudo&quot;</span><span class="p">,</span> <span class="s2">&quot;Jodeci&quot;</span><span class="o">]</span>
</span><span class='line'><span class="no">Staff</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:username</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">4</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;staffs&quot;</span><span class="o">.</span><span class="s2">&quot;username&quot;</span> <span class="no">FROM</span> <span class="s2">&quot;staffs&quot;</span> <span class="no">WHERE</span> <span class="s2">&quot;staffs&quot;</span><span class="o">.</span><span class="s2">&quot;type&quot;</span> <span class="no">IN</span> <span class="p">(</span><span class="s1">&#39;Staff&#39;</span><span class="p">)</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;Jodeci&quot;</span><span class="o">]</span>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">count</span> <span class="c1">#=&gt; 2</span>
</span><span class='line'><span class="no">Staff</span><span class="o">.</span><span class="n">count</span> <span class="c1">#=&gt; 1</span>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>  <span class="no">User</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">6</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span>  <span class="s2">&quot;users&quot;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&quot;users&quot;</span> <span class="no">ORDER</span> <span class="no">BY</span> <span class="s2">&quot;users&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">DESC</span> <span class="no">LIMIT</span> <span class="vg">$1</span>  <span class="o">[[</span><span class="s2">&quot;LIMIT&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="o">]]</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="c1">#&lt;Staff id: 2, username: &quot;Jodeci&quot;, password: &quot;12345&quot;, type: &quot;Staff&quot;, created_at: &quot;2015-12-31 07:12:16&quot;, updated_at: &quot;2015-12-31 07:12:16&quot;&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Table Inheritance 會繼承的東西：</h4>

<ul>
<li>欄位資訊：包括預設值或是 NOT NULL，也就是在 SQL 建構式中看到欄位敘述的內容。</li>
<li>父表上的欄位變動：也就是之後在父表上新增刪除修改欄位的變動，會確實的反應到子表上。</li>
</ul>


<h4>Table Inheritance 不會繼承的東西：</h4>

<ul>
<li>欄位資訊以外的全部：包括 Primary Key、Constraint 或是 Index 等。</li>
</ul>


<h4>主鍵重複值問題</h4>

<p>這應該是最大的困擾之一，就是繼承的子表的主鍵是可以和父表的值重複的，例如以下的程式碼是可以正確執行的：</p>

<figure class='code'><figcaption><span>測試title</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="ss">username</span><span class="p">:</span> <span class="s1">&#39;ryudo&#39;</span><span class="p">,</span> <span class="ss">password</span><span class="p">:</span><span class="s1">&#39;12345&#39;</span><span class="p">)</span> <span class="c1">#=&gt; 建立 id 為 1 的 User</span>
</span><span class='line'><span class="no">Staff</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="ss">username</span><span class="p">:</span><span class="s1">&#39;Jodeci&#39;</span><span class="p">,</span><span class="ss">password</span><span class="p">:</span><span class="s1">&#39;12345&#39;</span><span class="p">)</span> <span class="c1">#=&gt; 建立 id 為 1 的 Staff</span>
</span></code></pre></td></tr></table></div></figure>


<p>這樣在 users 表會真的有兩筆 id 為 1 的紀錄，而且目前無法用資料庫的方式去迴避這個問題，不過由於兩個 id 之間是共用同一個 Sequence，在不指定 id 建立資料的狀況下，id 的值是不會重複的。</p>

<h4>inheritance_column 存廢問題：</h4>

<p>在上面的範例中，我們可以看到原本 STI 的 inheritance_column，也就是 type 這個欄位的存在，原本 STI 的設計是：子類別的資料將會自動在 type 上加上類別名稱，查詢 Staff 時也會預設查詢 type 為 Staff 的資料。</p>

<p>這個設計是因為在資料同屬一張表的前提下，必需用一個欄位去區分類別的關係，而在 Table Inheritance 下，由於每個類別有獨立的資料表，在查詢子類別時已經不需要用 type 這個條件了；但是如果在父類別的資料表查詢時，還是需要用 inheritance_column 去區分出這筆資料所屬的類別，否則所有父類別資料表的資料在 ActiveRecord 中會被視為父類別的資料。</p>

<h4>多表繼承</h4>

<p>其實是有這項功能的，但是目前還沒想到需要使用的場合所以這次就不討論了。</p>

<h3>是否要使用這個功能？</h3>

<h4>好處</h4>

<ul>
<li>比起 ActiveRecord 提供的 STI 更趨近於物件化</li>
<li>由於資料表是物理上的切分，等於是一種 Partitioning，在資料量大的時候可以提升子表的效能</li>
<li>同上，減少欄位或 Index 等資源不必要的浪費</li>
</ul>


<h4>壞處</h4>

<ul>
<li>Rails 預設不支援相關的 Migration 操作，需手動撰寫 SQL</li>
<li>同上，在 Model 的設定上必需客製一些設定</li>
</ul>


<p>以上！</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/18/oedork-and-rwc/">大江戶 RubyKaigi 05, Asakusa.rb 以及 Ruby World Conference</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-18T11:03:00+08:00" pubdate data-updated="true">Nov 18<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/11/18/oedork-and-rwc/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>這篇 Blog 是我和五倍紅寶石的同事趙子皓於 11 月初一同參加了<a href="http://regional.rubykaigi.org/oedo05/">大江戶 RubyKaigi&#8217;05</a> 以及 <a href="http://2015.rubyworld-conf.org">Ruby World Conference 2015</a> 並分別發表的心得記事。</p>

<h3>逆邀講</h3>

<p>回到今年六月，在準備 RubyConf Taiwan 2015 時，想要邀請連續兩屆來台的 Ruby VM 作者笹田耕一來台發表，但由於他已預定在之後的 RubyConf Portugal 發表所以未能成行，在這信件一來一往中，突然被問到是否可以 11 月的大江戶 RubyKaigi 中發表，驚訝和榮幸之餘想說是一個難得的機會就答應了。</p>

<h3>Ruby World Conference&#8211;投稿與贊助</h3>

<p>和 RubyKaigi 或是 RubyConf 系列的技術研討會不同，這個在 Ruby City — 松江市舉辦的研討會是以「Ruby 的應用和生態」為主，由於敝社原本就是以促進 Ruby 受台灣的程式生態圈愛用為目標，所以就和同事嘗試著投稿看看，沒想到兩個人都順利入選。</p>

<p>除了投稿之外，由於在不論在社群或是公司的方面都受到了日本 Ruby 社群很多照顧，今年本著回饋的心情也贊助了這個活動，也成為了該活動史上第一個海外贊助商。</p>

<h3>行程</h3>

<p>由於大江戶和 RWC 剛好是在前後週，所以我們在大江戶的前一天（11/7）出發，然後在 RWC 結束後一天（11/14）回台。</p>

<h3>大江戶 RubyKaigi</h3>

<p>大江戶 RubyKaigi 是日本眾多<a href="http://regional.rubykaigi.org/">地區性 RubyKaigi</a> 中，歷史最悠久，規模最大的一個，主辦團隊是 Asakusa.rb，這次的場地在東京的中央區舉辦。</p>

<p>今年，也是第五屆的場地是在一個綜合會議中心，除了 7F 的會場外，在 13F 還提供了一個很大的休息區，休息區除了給大家交流之外還提供了會場畫面的 LIVE 直播。</p>

<blockquote class="twitter-tweet" lang="zh-tw"><p lang="ja" dir="ltr">大江戸Ruby会議05の様子ですよぅ 🌊 <a href="https://twitter.com/hashtag/oedo05?src=hash">#oedo05</a> <a href="https://twitter.com/hashtag/asakusarb?src=hash">#asakusarb</a> <a href="https://t.co/lusirCDZiW">pic.twitter.com/lusirCDZiW</a></p>&mdash; 大江戸Ruby会議 (@OedoRubyKaigi) <a href="https://twitter.com/OedoRubyKaigi/status/663176126617948160">2015 11月 8日</a></blockquote>


<p>門票方面，活動門票是 2,000， 不含午餐，After Party 是 5,000 日元，繼承 Asakusa.rb 對外國會眾友善的傳統，外國人和講者全免。</p>

<p>這個活動和一般認知的技術研討會不同的地方，就是它有許多被稱為「生活發表會」的議程；今年的議程除了兩場 Keynote 外，又分為「Ruby Committers&#8217; Lightning Talks」以及「Ninja Talks」兩種，前者顧名思議就是 Ruby Committer 專屬的 LT 時間，後者則是每場 15 分鐘的短講，會眾約 200 多人。</p>

<p>由於我自己的議程是在下午，所以在之前的議程就只有聽到一部份，以下就我自己有聽到的部份做個簡介：</p>

<ol>
<li><p>@usa：<a href="https://speakerdeck.com/unak/talk-about-io">あいおーのはなし（中譯：有關 IO 的話題）</a></p>

<p>講者是 CRuby Windows 版的主要維護者，這篇主要就是在討論 CRuby IO Class 內部實作方式的演進，然後表示他要在 Windows 上 Porting m17n IO 的功能。</p></li>
<li><p>松田明：「<a href="https://speakerdeck.com/a_matsuda/the-kaigi-must-go-on">The Kaigi Must Go On</a>」</p>

<p>講者是今年五月才在 ModernWeb 登台的大神松田明，內容是關於他接任 RubyKaigi 總召的經過，其中提到了原本去年 9 月 RubyKaigi 2014 之前就已經訂好了今年 Kaigi 的場地與時間，但是因為原本的總召角谷大大生了一場病所以中斷了籌備的事情，本來已經打算停辦了，後來由於他實在太常被國內外朋友們詢問是否還會有下一屆的事情，所以最後就自己出來接任總召了，身為 RubyConf.TW 的主辦人真是感到心有戚戚焉。</p></li>
<li><p>中田伸悅：「<a href="https://speakerdeck.com/n0kada/my-best-commits-of-the-year-2015">Best Commits of the year 2015 (仮)</a>」</p>

<p>講者是被稱為 &#8220;Patch Monster&#8221; 的，也是包括 Matz 在內的三位被 Heroku 全職聘用的 Ruby Committer 之一，簡短的內容提到了他在今年最滿意的幾個 Commit。</p></li>
<li><p>小栁真太：「<a href="http://www.slideshare.net/yancyajp/rubyseenfromsqlishbrain-54870167">SQL 脳から見た Ruby（中譯：從 SQL 腦看到的 Ruby）</a>」</p>

<p>講者和我一樣是 PostgreSQL 的同好，裡面講到如何把 SQL 查詢用 Ruby 語法去實作的方式，後面還提到了 PostgreSQL 的專有語法 with 等在 ActiveRecord 的用法，令人腦洞大開，with 相關介紹可以參照阿土伯大大在 Ruby Tuesday 24 的分享。</p></li>
<li><p>西嶋悠貴：「地獄のニューヨーク（紐約）」</p>

<p>講者是新進的 Ruby Committer，也是在國外工作的日本 Rubyist，裡面提到他在紐約的生活，例如怎麼租房子比較省錢，或是交通問題之類，其中最爆笑的一段就是提到當他在住宅遇到搶匪，逃到樓下對面的 PUB 後，酒保竟然跟他說「總之先來一杯再說，我請客」，遺憾的是似乎沒有公開 Slide。</p></li>
<li><p>Kei Sawada：「<a href="https://speakerdeck.com/remore/xiang-jie-burn">詳解Burn</a>」</p>

<p><a href="https://github.com/remore/burn">Burn</a> 是一個可以讓你用 DSL 去寫出任天堂 ROM 的Ruby Gem，去年在 RubyKaigi 就有聽到這個令人印象深刻的議程，這次還加上 telnet mode 的功能，後面還提到了一些 g0v。</p></li>
</ol>


<h4>After Party 和二次與三次會</h4>

<p>這次的 Party 是在知名的 Recruit 公司的員工餐廳舉辦，Party 除了啤酒喝到飽之外，料理陣容也非常豪華，同時還有講者繼續白天的話題，現場又跟大家討論了起來。</p>

<p><img src="/images/201511-OEDO-RWC/thumb_IMG_1686_1024.jpg" alt="" /></p>

<p>Party 結束時大概是 9:30 左右，這時很神奇地就會有一群人自動的聚集在一起等待二次會的來臨，二次會在附近的小 Pub 裡續攤，神奇的是在那個場合中，依然看到 Patch Monster 大大在改 CRuby Source Code XD。</p>

<p>由於二次會時偶然提到很想唱歌，所以就變成在附近的 KTV 進行人生第一次的三次會了 XD，最後在快一點時趕上了終電（最後一班電車）回到旅館。</p>

<p><img src="/images/201511-OEDO-RWC/thumb_IMG_1688_1024.jpg" alt="" /></p>

<h3>Asakusa.rb</h3>

<p>Asakusa.rb 是一個在東京定期舉辦的 Ruby 社群聚會，除了定期聚會以外，也主辦包括前面提到的大江戶，以及每年 RubyKaigi 的 pre-Party，一直以來都很想參加，趁著這次的機會終於可以一嘗宿願。</p>

<p>這次的活動在位於秋葉原附近的<a href="http://www.esm.co.jp">永和 System Management 公司</a>舉辦，活動本身沒有主題演講等，比較像是我們經常在動漫畫裡看到的「部活」，也就是社團活動，大概在晚上七點開始會陸續的有人加入，然後有的人會聚在一起討論或是做自己的事。</p>

<p><img src="/images/201511-OEDO-RWC/thumb_IMG_1700_1024.jpg" alt="" /></p>

<p>大概到了 20:30 ，松田大大就開始請大家自我介紹，大概到 9:30 前部活階段就結束了，接下來就移師到附近的居酒屋舉行二次會，這時松田大大突然對我說；「真正的 Asakusa.rb 現在才開始」，然後就是喝酒聊天了，由於小弟的日文不太輪轉，和大家聊天時松田大大還會很貼心的請大家對我「慢慢地講話」，二次會在大概 12:00 左右結束。</p>

<h3>Ruby World Conference</h3>

<p><img src="/images/201511-OEDO-RWC/RWC-AllSpeakers.jpg" alt="" /></p>

<p>和我們熟知的，針對開發者為主的 RubyConf 系列或是 RubyKaigi 不同，在 Ruby 之父的家鄉島根縣松江市舉辦的 Ruby World Conference 專注在「Ruby 的應用」而非技術。</p>

<p>接著週三就前往羽田機場搭上往出云機場的飛機，在下午四點左右到達了旅館，當天晚上有限定講者和相關人士參加的 pre-Party，是在一間很傳統的日式餐廳舉辦，現場請每位講者上來自我介紹，在場和這次大會的 Keynote Spaker 的 Linda Liukas 相見歡，同時也認識了 RG 松江的主辦團隊，由於其中兩位都是媽媽，話題很快就轉移到育兒經上面 XD。</p>

<p>Pre-Party 結束後，主辦單位很貼心的招待大家搭計程車回到旅館，<del>雖然有二三次會但是因為要準備演講的關係只好 Pass</del>。</p>

<p>隔天就開始了 RWC 的正式議程，開場時先請所有的講者到舞台上合照，接著就是一些地方政治人物像是島根縣長等的致詞，和我們對一般政治人物致詞很「搞威」的印象不同，每位的致詞時間都不超過五分鐘，接下來就是 Matz 的主題演講，這次的演講主題是「Second System Syndrome」，內容和不久前 <a href="https://www.youtube.com/watch?v=cydW3bvUOKQ&amp;index=3&amp;list=PLhKZ4RWngmpDVKgAH_p_X7gtLSGsvmMJj">RubyConf Taiwan 2015 的發表</a>沒有很大的差異。</p>

<p>在單軌兩天的議程中，大會提供了「雙向」的即時口譯服務，接下來的議程由於都在準備講稿和練習（我是第二天倒數第二個講者），幾乎都沒有參加到。</p>

<p>會場是在當地最大的會議中心，除了三樓的演講廳之外，在一樓有一個比演講廳還大的攤位交流區，這裡同時也是會眾午餐以及晚上 Official Party 的場地，攤位的外觀和陳列方式感覺比較像台灣每年五六月間舉辦的 Computex Taipei 這樣的商業展覽，贊助商多半也是在展示自己的技術解決方案之類，沒有看到徵才。</p>

<p>除了交流區的攤位之外，還有一樓的地方旅遊介紹以及 Ruby 拉麵攤位，第二天也帶了一組 Ruby 拉麵回家。</p>

<p>三樓會場外還有一個茶席區，穿著和服的妹妹會用傳統日本茶道的方式磨出抹茶和點心然後再端上來給你。</p>

<p>第一天晚上的 Official Party 當然也是酒類無限暢飲，不過由於一直在交流遞名片聊天的關係所以幾乎沒吃到多少東西（淚～），這個 Party 除了吃吃喝喝外，還有奇妙的島根吉祥物 しまねっこ 出沒。</p>

<blockquote class="twitter-tweet" lang="zh-tw"><p lang="en" dir="ltr">Meeting with Shimanekko, the mascot of Shimane. 😻 <a href="https://twitter.com/_zzak">@_zzak</a> and my next talk might just be the cat dance. <a href="https://t.co/TkgL6zK6hU">pic.twitter.com/TkgL6zK6hU</a></p>&mdash; Linda Liukas (@lindaliukas) <a href="https://twitter.com/lindaliukas/status/664777586308870144">2015 11月 12日</a></blockquote>


<p>另一個讓我印象很深的地方，就是在會場有寄放衣服與背包的地方，超貼心。</p>

<p>Party 結束後，當然也是有各種二次三次會，不過一樣由於隔天有演講的關係，只能在電腦前看著已經完成發表的同事邊唱 KTV 邊發推😂。</p>

<p><img src="/images/201511-OEDO-RWC/RWC-at-stage.jpg" alt="" /></p>

<p>第二天全部議程結束後，參加了一場需要事先報名的當地特產啤酒燒肉會，接下來一樣有各種續攤，三次會是和一群日本各地的 RG 主辦人一起交流 RG 主辦的經驗等等，拜同行的日文通子皓的幫忙，可以更加輕鬆的交流了，在整個活動期間認識了許多不同城市的 RG 主辦人或教練，真的很開心。</p>

<p>最後一天的早上，在搭車前往機場之前短暫的參觀了 RG 松江，這邊的規模雖然不大，不過會場的佈置很用心，和台灣不一樣的是，一組的配置是 2 位教練配四位學員，等於是台灣兩組的配置，現場還有機器人&#8230;以及 Matz 的立牌。</p>

<p><img src="/images/201511-OEDO-RWC/thumb_IMG_1765_1024.jpg" alt="" />
<img src="/images/201511-OEDO-RWC/thumb_IMG_1775_1024.jpg" alt="" />
<img src="/images/201511-OEDO-RWC/thumb_IMG_1769_1024.jpg" alt="" /></p>

<p>在活動開場後，有 Matz 和 Linda 的致詞，然後我也突然被拉上去致詞了 XD，再度獲得了另一個人生的成就。</p>

<blockquote class="twitter-tweet" lang="zh-tw"><p lang="ja" dir="ltr">台湾より…！！&#10;<a href="https://twitter.com/hashtag/railsgirlsmatsue?src=hash">#railsgirlsmatsue</a> <a href="https://t.co/RBmgXMEH8k">pic.twitter.com/RBmgXMEH8k</a></p>&mdash; yadaita (@yadaita) <a href="https://twitter.com/yadaita/status/665346316826865665">2015 11月 14日</a></blockquote>


<p>最後就在各種趕飛機（出雲 -> 羽田 -> 松山）中結束了整個行程。</p>

<h3>個人成就紀錄</h3>

<p>在這次八天的日本行之中，完成了各種成就，包括：</p>

<ul>
<li>在海外用英文發表技術 &amp; 非技術議題</li>
<li>一週內兩次英文發表</li>
<li>在英文發表前用日文自介</li>
<li>和日本人唱 KTV</li>
<li>二次會 &amp; 三次會</li>
<li>趕終電</li>
</ul>


<h3>感想</h3>

<h4>地方的熱情</h4>

<p>最讓我印象深刻的，就是在日本這個國家，即使是所謂的「田舍」，也就是鄉下地方的人或是政府單位都會很努力的用實際的方式（而不是炒地皮之類）來振興地方的經濟與發展，像 RWC 這種幾乎由地方政府一手主辦的活動就是一個很顯著的例子，為了吸引外國人參加，甚至不惜重本不計成效（畢竟全場只有 15 來個外國人）的提供雙向口譯服務；同時也認識了許多地方的 IT 公司，像是 Matz 以前所屬的 <a href="http://www.netlab.jp">NaCl</a> 等等，很努力的把工作機會帶回自己出身的地方，這點和台灣是很不一樣的；另外松江的消費水平，像是食宿或交通費用（主要是計程車）幾乎和東京沒有什麼差別。</p>

<p>這次也認識了很多地方 RG 活動，像是神戶、松江甚至是以前沒聽過的塩尻等等的主辦人，他們很熱心的將 RG 活動帶到自己的家鄉，同時很多 RG 的教練，例如敝公司的好捧友<a href="http://5xruby.tw/posts/interview-with-igarashi">五十嵐邦明</a>等人，也會從東京自費（或是公司贊助）過去支援；縱觀 RG 的世界各地活動列表可以發現，日本的都市數量是全世界所有國家最多的，活動的頻率也是最頻繁的，可以感受到他們社群之間互相支援的熱情。</p>

<h4>多樣的 Ruby</h4>

<p>一直以來 Ruby 在台灣的認知就是 = Rails，甚至還有很多人把 Rails 誤認為一門語言，雖然我也是從 Rails 入門 Ruby，但是在熟練到一定程度之後就開始著眼於 Rails 或 Web 以外的 Ruby 應用；在這次日本行中又再次見識到 Ruby 的多樣性，以及日本人把 Ruby 的應用延伸到各個層面上的努力，像是這次我就認識了用 Ruby 控制都市瓦斯的系統，或是用 mruby 控製太陽能發電系統的公司，而且在大學也有相關的研究，我想除了 Ruby 是日本發明的語言之外，也包括了日本人對基礎研究的動力，這點和台灣是非常不同的。</p>

<h4>社群的熱情</h4>

<p>有人認為，區別一個國家是否現代化的方式，就是在於其中的人民有沒有一個「對國家主體的認同和想像」而非對個別人物的效忠；我想這點也適用在 Ruby 或是任何的 Open Source 社群上，在日本的 Ruby 社群可以感受到大家對於 Ruby 社群這個主體的認同，各個地區的社群間也會互相支援，例如在我參加 RWC 之前，一直有「這就是很 local 的活動」的刻板印象，不過實際參加之後才發現真的有很多來自東京的 Rubyist 們或公司在會場出沒甚至贊助，包括前面提到的 RG 互相支援，都可以體現出日本的 Ruby 社群有一個共同的認同主體，進而在這個主體之下互相扶持，共同發展的熱情。</p>

<h3>最後</h3>

<p>整體來說，我認為這次的日本行可說是收獲滿滿，最大的遺憾是因為行程排的太緊加上八天兩場發表的關係，沒有好好的在松江當地觀光；希望明年可以作為普通的會眾參加這些活動。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/09/20/rubyconftw-2015-retro/">RubyConf Taiwan 2015</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-09-20T10:34:00+08:00" pubdate data-updated="true">Sep 20<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/09/20/rubyconftw-2015-retro/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="/images/rubyconftw2015-og.png" alt="" /></p>

<p>今年是第五屆的 RubyConf Taiwan，也是第二次以總召的身份主辦這項活動。</p>

<h3>Matz Driven Development</h3>

<p>去年九月和龍哥帶著<a href="http://blog.annideas.com/2014/09/29/a-ruby-week-in-japan-1/">一群 Rails Girl 們</a>去參加 <a href="http://rubykaigi.org/2014">RubyKaigi 2014</a> ，在會前的某個特別 Party 上遇到 Matz，意外的被問到 2015 的 RubyConf Taiwan 何時舉辦，當時因為老婆的預產期在今年 2 月，所以就當場回覆可能無法在上半年舉辦，最後就和 Matz 敲定了大概會在今年的 9 月，所以我們是 Matz Driven Development 無誤。</p>

<h3>用公司推動 Conf</h3>

<p>剛好在去年的 RubyConf Taiwan 的前夕，考慮到未來的社群發展，和龍哥等人成立了 <a href="http://5xruby.tw">五倍紅寶石</a> 這間公司來推廣 Ruby，之後經過將近一年的努力經營之後，公司也漸漸開始有能力支援 <a href="http://5xruby.tw/posts/5xruby-support-sitcon">Sitcon</a> / Rails Girls Taipei / Weekly 和 Ruby Tuesday 等等，在這幾個月，可以說幾乎動用了整間公司的人力在舉辦這個活動。</p>

<p>以往在準備活動時，往往是以草創的心態去做，很多事情的聯繫或處理往往做的不到位或是有失誤的地方，今年要特別感謝敝公司的管理員 Sabrina ，帶領幾位同仁將大部份（對我來說）瑣碎的事務以最洗練的方式處理好，讓我幾乎不需要煩惱講者 / 贊助商 / 預算以外的事情，而且能適時的給我許多建議，讓我發現許多事情其實還可以做的比想像的更好。</p>

<h3>Matz is awseome, so we are awesome</h3>

<ul>
<li><p>補助外國講者住宿</p>

<p><img src="/images/IMG_0587.jpg" alt="" /></p>

<p>來自 11 個不同國家的外國講者們，除了 Keynote Speaker 以外，全部都是自費來台，為了體貼遠道而來的外國講者們，今年特地補助外國講者免費住宿中研院的客房服務。</p></li>
</ul>


<blockquote class="instagram-media" data-instgrm-captioned data-instgrm-version="4" style=" background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);"><div style="padding:8px;"> <div style=" background:#F8F8F8; line-height:0; margin-top:40px; padding:50.0% 0; text-align:center; width:100%;"> <div style=" background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAAGFBMVEUiIiI9PT0eHh4gIB4hIBkcHBwcHBwcHBydr+JQAAAACHRSTlMABA4YHyQsM5jtaMwAAADfSURBVDjL7ZVBEgMhCAQBAf//42xcNbpAqakcM0ftUmFAAIBE81IqBJdS3lS6zs3bIpB9WED3YYXFPmHRfT8sgyrCP1x8uEUxLMzNWElFOYCV6mHWWwMzdPEKHlhLw7NWJqkHc4uIZphavDzA2JPzUDsBZziNae2S6owH8xPmX8G7zzgKEOPUoYHvGz1TBCxMkd3kwNVbU0gKHkx+iZILf77IofhrY1nYFnB/lQPb79drWOyJVa/DAvg9B/rLB4cC+Nqgdz/TvBbBnr6GBReqn/nRmDgaQEej7WhonozjF+Y2I/fZou/qAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;"></div></div> <p style=" margin:8px 0 0 0; padding:0 4px;"> <a href="https://instagram.com/p/7cLiTZoF93/" style=" color:#000; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none; word-wrap:break-word;" target="_top">ホテルついたー。快適〜。</a></p> <p style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;">A photo posted by igaiga (@igaiga555) on <time style=" font-family:Arial,sans-serif; font-size:14px; line-height:17px;" datetime="2015-09-10T06:38:49+00:00">Sep 9, 2015 at 11:38pm PDT</time></p></div></blockquote>


<script async defer src="//platform.instagram.com/en_US/embeds.js"></script>


<ul>
<li><p>使用 Icecast 做口譯接收解決方案</p>

<p>去年第一次嘗試在 Conf 做中翻英的即時口譯服務，當時因為場地因素，就找了專業的翻譯社架口譯間以及租借 Receiver；今年因為回到中研院，由於會場具備口譯間以及有 CPRTeam 支援網路的情況下，就決定使用之前 HITCON 使用的 Icecast 做口譯語音廣播的解決方案，讓外國會眾們用自己的手機接收口譯語音，得到了許多正面回應。</p></li>
</ul>


<blockquote class="twitter-tweet" lang="zh-tw"><p lang="en" dir="ltr">&quot;Using Icecast instead of Receiver Equipment&quot;, that was a very nice idea! And that helped me so much. Thank you!! <a href="https://twitter.com/hashtag/rubyconftw?src=hash">#rubyconftw</a></p>&mdash; ゆかお(Yuka) (@yucao24hours) <a href="https://twitter.com/yucao24hours/status/642638603877793792">2015 9月 12日</a></blockquote>




<blockquote class="twitter-tweet" lang="zh-tw"><p lang="ja" dir="ltr">お手元のiPhoneにイヤホン差したら同時通訳レシーバーになるのとても便利だ <a href="https://twitter.com/hashtag/rubyconftw?src=hash">#rubyconftw</a></p>&mdash; Kakutani Shintaro (@kakutani) <a href="https://twitter.com/kakutani/status/642162711409750016">2015 9月 11日</a></blockquote>


<ul>
<li><p>Pre-Conf Party</p>

<p>由於經費與人力考量，以往 Conf 前通常沒有正式的活動，今年在 Conf 前兩天在敝礦坑舉辦 Pre-Conf Party，增加一個交流的機會。</p></li>
</ul>


<blockquote class="twitter-tweet" lang="zh-tw"><p lang="en" dir="ltr">Beer and food! Pre-Conf party with so many <a href="https://twitter.com/hashtag/rubyfriends?src=hash">#rubyfriends</a> <a href="https://twitter.com/hashtag/rubyconftw?src=hash">#rubyconftw</a> <a href="http://t.co/jnR6pBf9FH">pic.twitter.com/jnR6pBf9FH</a></p>&mdash; Tina Huang (@tinating_h) <a href="https://twitter.com/tinating_h/status/641578793556033536">2015 9月 9日</a></blockquote>


<h3>場內</h3>

<ul>
<li><p>茶 / 咖啡贊助商</p>

<p>去年首次在活動中引進茶贊助商就有相當不錯的回應，後來也引發各大 Conf 爭相採用，今年剛好因為龍哥的關係認識了 iOS 大神張景隆夫妻經營的蘋果貓咖啡，另外剛好實習生的馨儀家裡又是經營茶莊的，就一次湊齊了兩種飲料攤位；連 Tenderlove 大神都表示他覺得這裡的咖啡比他住的西雅圖（星巴客發源地）的還要厲害，聽說連來自比利時的 @lrz 大神都帶了幾包回去。</p></li>
</ul>


<p><img src="/images/2015-09-11%2010.33.41.jpg" alt="" /></p>

<ul>
<li><p>在會場交誼廳舉辦 Party</p>

<p>從 2012 起，我們就有在第一天晚上舉辦 Official Party 的傳統，前兩屆都在同一間 Lounge Bar 舉辦，雖然不用自己準備，但是需要一筆包場費用，也因此 Party 和 Conf 都要分開購票；今年直接使用會場四樓的交誼廳做為 Party 會場，從外面叫外燴，再配合 <a href="https://wish8.com">Wish8</a> 和 金色三麥贊助的啤酒，除了讓所有人都可以參加 Party 外，沒有座位的設定也讓大家比較容易主動交流。</p></li>
</ul>


<blockquote class="twitter-tweet" lang="zh-tw"><p lang="en" dir="ltr">Start <a href="https://twitter.com/hashtag/RubyConfTW?src=hash">#RubyConfTW</a> <a href="http://t.co/uzQmocQTju">pic.twitter.com/uzQmocQTju</a></p>&mdash; 小影 ☂ (@siuying) <a href="https://twitter.com/siuying/status/642292642991075328">2015 9月 11日</a></blockquote>




<blockquote class="twitter-tweet" lang="zh-tw"><p lang="en" dir="ltr">Beer time @ <a href="https://twitter.com/hashtag/rubyconftw?src=hash">#rubyconftw</a> <a href="http://t.co/MhnGcgg8Kp">pic.twitter.com/MhnGcgg8Kp</a></p>&mdash; 小影 ☂ (@siuying) <a href="https://twitter.com/siuying/status/642290286178123776">2015 9月 11日</a></blockquote>


<ul>
<li><p>RFID by Codeme.cc</p>

<p>以往贊助商擺攤，都需要自行收集會眾的資料，對於贊助商和會眾多有所不便之處，今年剛好透過龍哥認識了 PyCon 協辦單位之一的 GliaCloud，他們研發了一套 Raspberry Pi + RFID 打卡的解決方案，雙方討論之後就決定引進這個服務給贊助商使用，也感謝 Andy 和 Django Girl Taipei 的主辦人 Michelle 在場佈與兩天活動的全力支援，誰說不同語言 / 社群之間就不能通力合作呢？</p></li>
</ul>


<blockquote class="twitter-tweet" lang="zh-tw"><p lang="en" dir="ltr">Badges linked with events <a href="https://twitter.com/hashtag/rubyconftw?src=hash">#rubyconftw</a> <a href="http://t.co/QtvAULcUPK">pic.twitter.com/QtvAULcUPK</a></p>&mdash; 小影 ☂ (@siuying) <a href="https://twitter.com/siuying/status/642288588722298885">2015 9月 11日</a></blockquote>


<p></p>

<h3>團隊</h3>

<ul>
<li>議程：ihower</li>
<li>設計：Rice / 康橋</li>
<li>顧問：龍哥</li>
<li>統籌：Sabrina</li>
<li>場地協調：Rock（OSSF）</li>
<li>攝影：徐聖淵</li>
<li>執行：Tina / 馨儀 / Nina</li>
<li>網站：Nina / 西瓜 / Tina / 蒼時</li>
<li>口譯：Sarah / 宜靜</li>
<li>司儀：Lillian / 郁蓁</li>
<li>場務：Tina / 馨儀 / Nina / 雯晴 / 嘉佑 / Christine / okay / 椽家 / 孟穎 / 宇辰 / 芳妤 / 毓柔 / 佾庭 / 詩晴</li>
<li>會場網路：Mouse / Pennyyken（CPR Team）</li>
<li>RFID：Andy / Michelle（Gliacloud）</li>
<li>外交大使：@juanitofatas</li>
</ul>


<h3>結語</h3>

<p>感謝贊助商 / 協力夥伴 / Staff / 講者以及許多朋友的幫忙才能促成今年的活動順利舉辦，謝謝大家！</p>

<blockquote class="twitter-tweet" lang="zh-tw"><p lang="en" dir="ltr">All <a href="https://twitter.com/hashtag/rubyconftw?src=hash">#rubyconftw</a> staffs with <a href="https://twitter.com/tenderlove">@tenderlove</a> &#39;s cat sticker <a href="http://t.co/vtKYiGRnHs">pic.twitter.com/vtKYiGRnHs</a></p>&mdash; Mu-Fan Teng (@ryudoawaru) <a href="https://twitter.com/ryudoawaru/status/642683230055825413">2015 9月 12日</a></blockquote>




<blockquote class="twitter-tweet" lang="zh-tw"><p lang="en" dir="ltr"><a href="https://twitter.com/hashtag/rubyconftw?src=hash">#rubyconftw</a> Staffs and <a href="https://twitter.com/masterwujiang">@masterwujiang</a> after party. <a href="http://t.co/mqbOBr3kjy">pic.twitter.com/mqbOBr3kjy</a></p>&mdash; Ruby Taiwan (@rubytaiwan) <a href="https://twitter.com/rubytaiwan/status/642353458939478016">2015 9月 11日</a></blockquote>


<p> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/20/fix-locale-in-linux/">解決用 Mac 登入 Linux 主機時出現的 Locale 警告訊息</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-20T16:07:00+08:00" pubdate data-updated="true">Feb 20<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/02/20/fix-locale-in-linux/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>前陣子用 Mac 登入遠端的 Linux 主機時常常遇到一個有點討厭的訊息：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>-bash: warning: setlocale: LC_CTYPE: cannot change locale <span class="o">(</span>UTF-8<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>這個狀況是從幾個月前突然發生的，Google 之後發現兩種解法：</p>

<ol>
<li><p>修改主機 locale 設定</p>

<p>編輯：/etc/environment 或是 .bash_xxx 等檔案並輸入：
<code>
LANG=en_US.utf-8
LC_ALL=en_US.utf-8
</code></p></li>
<li><p>修改 iterm 設定</p></li>
</ol>


<p><img src="/images/iterm-local-setting.jpg" alt="" /></p>

<p>將裡面的 &#8220;Set locale variables automatically&#8221; 取消勾選即可。</p>

<h3>相關連結</h3>

<ul>
<li>https://sskaje.me/2014/01/lc-ctype-issue/#.VOwSjULdVRE</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/18/automatic-urlhelper-test-in-rails/">自動化測試 Rails 中的 URL HELPER</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-18T12:51:00+08:00" pubdate data-updated="true">Feb 18<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/02/18/automatic-urlhelper-test-in-rails/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>前言：</h3>

<p>最近在某個和客戶共同開發的專案中，遇到了以下的情形：</p>

<ol>
<li>專案的 layout / view 經過大幅的改版</li>
<li>改版是把舊 layout（以下簡稱 ver1）的大部份功能改出一份新版 layout / view / controller（以下稱 ver2）</li>
<li>改版後幾乎沒有移除 ver1 重複的部份，因此系統中存著很多其實用不到的 view / controller / route</li>
<li>又因為改版後不想改變在 production env 的 url，所以在路由設定中用了大概是類似的架構：

<ul>
<li>Development 中有 /ver1 和 /ver2 兩個 route namespace，而且有 base uri，意即可能會有 /ver1/products 和 /ver2/products</li>
<li>Production 中，這兩個 namespace 的 base uri 會被消除，舉例來說，如果遇到 /products 的 request，系統會先找 /ver2 有沒有 /products，有的話會先使用，沒有再去找 /ver1</li>
</ul>
</li>
</ol>


<p>所以系統最後就存在一堆功能重疊的 controller / view / layout 了，現在的工作是要移除 /ver1 和 /ver2 中重複的部份。</p>

<h3>執行：</h3>

<p>基本上就是高科技手工業，程序如下：</p>

<ol>
<li>找 /ver2 的 route，假設現在的目標是 resources :users</li>
<li>在 /ver1 上找尋類似的 resource</li>
<li>如果有，就把 /ver1 的刪掉</li>
<li>如果不是單純的 Restful CRUD（意指有其它非 index. show, create 等標準 action 的 action）就得要一一檢查在 /ver2 上是否都有相對應的 action</li>
<li>找到所有的 view / helper / asset / controller 中是否有用到 /ver1 上的 url helper method，然後統一取代</li>
</ol>


<p>以上程序有效的前提是，所有的 URL 都用 helper method 而不用純字串或 url_for 等。</p>

<p>事情聽起來好像不是很難，不過這個專案可怕的地方就在於數百行的 route 中幾乎沒有單純 CRUD 的 resource，所以和同事花上了很多時間在手工上，完成後的問題就是，要怎樣確保沒有遺漏的地方。</p>

<p>於是想到，是否可以將程式中所有用到的 url helper method 集合起來一一做檢查呢？最後想到的解法大意如下：</p>

<ol>
<li>用文字搜尋的程式，以正規表示式去找出程式碼中使用的 url helper method</li>
<li>將找到的 method 集合產生列表</li>
<li>用列表產生 it 區塊</li>
<li>it 區塊中使用 <a href="https://www.relishapp.com/rspec/rspec-rails/v/2-4/docs/helper-specs/helper-spec">helper spec</a> 去測試 view context 中是否有這些 method</li>
</ol>


<p>文字搜尋採用目前比較流行的 <a href="http://beyondgrep.com/">ack</a>，好處是除了速度快之外又是 Perl 版的 Regexp，比 egrep 內建的更貼近 Ruby 使用的版本</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ack --noheading -h <span class="s1">&#39;[^A-Za-z0-9_.].((ver1|ver2)[\\w_]+?\_(url|path))&#39;</span> app/ --output <span class="s1">&#39;$1&#39;</span> | sort | uniq
</span></code></pre></td></tr></table></div></figure>


<p>使用的 ack 參數如下：</p>

<ul>
<li>正規表示式為：<code>[^A-Za-z0-9_.].((ver1|ver2)[\\w_]+?\_(url|path))</code></li>
<li>&#8211;noheading 不顯示檔案名在頭</li>
<li>-h 不顯示檔名在左邊</li>
<li>&#8211;output &#8216;$1&#8217; 只顯示批配的第 1 項</li>
</ul>


<p>測試的程式大概長的像這樣：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">describe</span> <span class="no">ApplicationHelper</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:helper</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">fn</span> <span class="o">=</span> <span class="s2">&quot;tmp/url_helpers.txt&quot;</span>
</span><span class='line'>  <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;ack --noheading -h &#39;[^A-Za-z0-9_.].((ver1|ver2)[</span><span class="se">\\</span><span class="s2">w_]+?\_(url|path))&#39; app/ --output &#39;$1&#39; | sort | uniq &gt; </span><span class="si">#{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">system</span> <span class="n">cmd</span>
</span><span class='line'>  <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">url_helper_name</span><span class="o">|</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;Url helper </span><span class="si">#{</span><span class="n">url_helper_name</span><span class="si">}</span><span class="s2"> should be available&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">helper</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="n">url_helper_name</span><span class="o">.</span><span class="n">to_sym</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>這樣一跑完就可以放心了。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/15/upgrade-pgsql-from-93-to-94/">在 Mac / Homebrew 下升級 PostgreSQL 從 9.3 到 9.4</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-15T22:10:00+08:00" pubdate data-updated="true">Feb 15<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/02/15/upgrade-pgsql-from-93-to-94/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>前言</h3>

<p>PostgreSQL 和 MySQL 不同，資料檔格式會隨著小數點二位數以上的版號（9.3 - 9.4）變動，換句話說每當升級版本時，資料檔就必需要升級才可以繼續使用。</p>

<p>升級的方式有兩種：</p>

<ul>
<li>將原本的資料執行 <a href="http://www.postgresql.org/docs/9.4/static/app-pg-dumpall.html">pg_dumpall</a> 後再 restore 回去</li>
<li>用 <a href="http://www.postgresql.org/docs/9.4/static/pgupgrade.html">pg_upgrade</a> 命令從舊的資料檔產生出新版本的資料檔。</li>
</ul>


<p>這邊要講的是第二種情形。</p>

<h3>環境限定：</h3>

<ul>
<li>可執行 <a href="http://brew.sh/">Homebrew</a> 的 MacOS 環境</li>
<li>原 PostgreSQL 為 Homebrew 安裝，9.3.x 版</li>
</ul>


<h3>步驟</h3>

<ol>
<li>安裝新的 PostgreSQL

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew update
</span><span class='line'>brew install postgresql
</span></code></pre></td></tr></table></div></figure>

</li>
<li>停止現在的 PostgreSQL Daemon
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>launchctl unload ~/Library/LaunchAgents/homebrew.mxcl.postgresql.plist
</span></code></pre></td></tr></table></div></figure>
</li>
<li>建立 9.4 的資料庫檔案
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>initdb /usr/local/var/postgres9.4 -E utf8
</span></code></pre></td></tr></table></div></figure>
</li>
<li>使用 pg_upgrade 指令升級 舊PG的資料檔案到 9.4，注意這邊的 9.3.5_1 和 9.4.0 是會依照你的舊版本和實際安裝的新板本的版號而有差異的

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>pg_upgrade -v <span class="se">\</span>
</span><span class='line'>    -d /usr/local/var/postgres <span class="se">\</span>
</span><span class='line'>    -D /usr/local/var/postgres9.4 <span class="se">\</span>
</span><span class='line'>    -b /usr/local/Cellar/postgresql/9.3.5_1/bin/ <span class="se">\</span>
</span><span class='line'>    -B /usr/local/Cellar/postgresql/9.4.0/bin/
</span></code></pre></td></tr></table></div></figure>
</li>
<li>將舊資料檔備份，並且讓新資料檔的目錄更名使之變成預設的資料檔

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> /usr/local/var
</span><span class='line'>mv postgres postgres9.3
</span><span class='line'>mv postgres9.4 postgres
</span></code></pre></td></tr></table></div></figure>
</li>
<li>
重啟 PostgreSQL

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>launchctl load ~/Library/LaunchAgents/homebrew.mxcl.postgresql.plist
</span></code></pre></td></tr></table></div></figure>
</li>

<li>檢查 /usr/local/var/postgres/server.log 檔是否有正常啟動 server</li>
<li>如果原本有安裝
<a href="https://rubygems.org/gems/pg">pg GEM</a>
的話要重新安裝</li>
</ol>


<p>以上！</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Ruby World Conference 2015  <a href="http://2015.rubyworld-conf.org/ja/program/">Speaker</a></h1>
  <a href="http://2015.rubyworld-conf.org"><img src="/images/rwc2015_banner_A02@2x.png" /></a>
</section>
<section>
  <h1>Oedo RubyKaigi 05 Speaker</h1>
  <a href="http://regional.rubykaigi.org/oedo05"><img src="/images/CTSrVNNWIAQRTdc.png" /></a>
</section>
<section>
  <h1>RubyKaigi 2013 LT <a href="http://rubykaigi.org/2013/lightning_talks#ryudoawaru">speaker</a></h1>
  <a href="http://rubykaigi.org/2013/lightning_talks#ryudoawaru"><img src="/images/badgeLightningTalker@2x.png" /></a>
</section><section>
  
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/09/26/my-rubykaigi-2016-tour/">RubyKaigi 2016</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/23/apply-letsencrypt-ssl-under-nginx/">用 letsencrypt-cli Rubygem 在 Nginx 上實裝 Let&#8217;s Encrypt 免費 SSL 服務</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/05/upgrade-5xruby-to-5-dot-0-beta/">將 5xruby.tw 升級到 Rails 5.0.0.beta2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/02/upgrade-postgresql-on-osx/">在 OSX 下升級 Homebrew 安裝的 PostgreSQL(dump 版)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/31/pgsql-inheritance/">Table Inheritance in PostgreSQL</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/ryudoawaru">@ryudoawaru</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'ryudoawaru',
            count: 2,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("ryudoawaru", 6, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/ryudoawaru" class="twitter-follow-button" data-show-count="false">Follow @ryudoawaru</a>
  
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Mu-Fan Teng -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'ryudosoctopress';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
